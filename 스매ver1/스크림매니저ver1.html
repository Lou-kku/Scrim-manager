<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오버워치 내전 관리기 (최종판)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        :root { --bg-color: #1e1f22; --primary-color: #2b2d31; --secondary-color: #383a40; --text-color: #dbdee1; --accent-color: #f99e1a; --win-color: #4CAF50; --loss-color: #F44336; --tank-color: #42a5f5; --damage-color: #ef5350; --support-color: #66bb6a; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--primary-color); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); overflow: hidden; }
        header { background-color: var(--secondary-color); padding: 20px; text-align: center; border-bottom: 2px solid var(--accent-color); }
        h1 { font-size: 2em; color: var(--accent-color); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        nav { display: flex; flex-wrap: wrap; background-color: var(--secondary-color); }
        nav button { flex-grow: 1; padding: 15px; background: none; border: none; color: var(--text-color); font-size: 1em; cursor: pointer; transition: background-color 0.2s, color 0.2s; border-bottom: 3px solid transparent; }
        nav button.active { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 700; }
        main { padding: 25px; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.8em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--secondary-color); color: #fff; }
        h3 { font-size: 1.4em; margin-bottom: 15px; color: var(--accent-color); }
        h4 { font-size: 1.2em; margin-bottom: 10px; color: #fff; padding-bottom: 5px; border-bottom: 1px solid var(--secondary-color);}
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; background-color: var(--bg-color); border: 1px solid var(--secondary-color); border-radius: 6px; color: var(--text-color); font-size: 1em; }
        button.primary-btn, .data-btn { background-color: var(--accent-color); color: #111; padding: 12px 20px; border: none; border-radius: 6px; font-size: 1em; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
        .danger-btn { background-color: var(--loss-color); color: #fff; border: none; border-radius: 6px; padding: 8px 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s; }
        .danger-btn:hover { background-color: #d32f2f; }
        #player-list { list-style: none; }
        #player-list li { background-color: var(--secondary-color); padding: 15px 20px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
        .role-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.9em; font-weight: 700; margin: 0 2px; color: #fff; white-space: nowrap; }
        .role-tank { background-color: var(--tank-color); } .role-damage { background-color: var(--damage-color); } .role-support { background-color: var(--support-color); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--secondary-color); }
        th { background-color: var(--secondary-color); font-size: 0.9em; }
        .team-selection-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .team-box { background-color: var(--secondary-color); padding: 20px; border-radius: 8px; }
        .player-stat-input-row { display: grid; grid-template-columns: 60px 1fr 50px 50px 60px; gap: 8px; margin-bottom: 10px; align-items: center; }
        .player-stat-input-row strong { font-size: 0.9em; color: var(--accent-color); text-align: right; }
        .player-name-cell { position: relative; cursor: pointer; }
        .player-tooltip { display: none; position: absolute; bottom: 100%; left: 0; background-color: var(--bg-color); border: 1px solid var(--secondary-color); border-radius: 6px; padding: 15px; z-index: 100; width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .player-tooltip.show-below { bottom: auto; top: 100%; }
        .player-name-cell:hover .player-tooltip { display: block; }
        .tooltip-section { padding-bottom: 8px; margin-bottom: 8px; border-bottom: 1px solid var(--secondary-color); }
        .tooltip-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .tooltip-elo { font-weight: bold; margin-bottom: 5px;}
        .tooltip-role-stats { font-size: 0.9em; }
        .section-divider { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--secondary-color); }
        #role-based-player-selection { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .role-selection-group .player-checkbox-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .generated-team-card { background-color: var(--secondary-color); border-radius: 8px; padding: 0; overflow: hidden; }
        .generated-team-card .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: rgba(0,0,0,0.2); }
        .player-list-container { padding: 10px 20px 20px; }
        .player-card { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--bg-color); }
        .player-card .player-name small { font-size: 0.8em; color: #aaa; margin-left: 5px; }
        .manual-balance-result { margin-top: 15px; font-size: 1.2em; font-weight: bold; text-align: center; color: #fff; }
        .edit-elo-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        #player-stats-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background-color: var(--secondary-color); border-radius: 8px; padding: 20px; }
        .stat-card-header { display: flex; align-items: center; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--primary-color); }
        .stat-card-elo { font-size: 1.2em; font-weight: bold; }
        .stat-card-body { list-style: none; margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .side-license-text { text-align: center; margin-top: 20px; font-weight: bold; color: var(--accent-color); font-size: 1.4em;}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>오버워치 내전 관리기 (최종판)</h1></header>
        <nav>
            <button id="nav-players" class="active">선수 관리</button><button id="nav-edit">선수 수정</button><button id="nav-stats">선수 통계</button><button id="nav-match">경기 결과 입력</button><button id="nav-ranking">랭킹 보드</button><button id="nav-builder">팀 생성 도우미</button>
        </nav>
        <main>
            <div id="view-players" class="view active"></div>
            <div id="view-edit" class="view"></div>
            <div id="view-stats" class="view"></div>
            <div id="view-match" class="view"></div>
            <div id="view-ranking" class="view"></div>
            <div id="view-builder" class="view"></div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- HTML 구조 삽입 ---
    const views = { players: document.getElementById('view-players'), edit: document.getElementById('view-edit'), stats: document.getElementById('view-stats'), match: document.getElementById('view-match'), ranking: document.getElementById('view-ranking'), builder: document.getElementById('view-builder') };
    views.players.innerHTML = `<h2>선수 명단 관리</h2><form id="add-player-form"><div class="form-group"><label for="player-name">새 선수 이름:</label><input type="text" id="player-name" placeholder="닉네임 입력" required></div><div class="form-group"><label for="initial-elo">초기 ELO (모든 역할군에 동일 적용):</label><input type="number" id="initial-elo" placeholder="예: 1200"></div><div class="form-group"><label>주 역할군:</label><div class="role-selector"><label><input type="checkbox" name="role" value="Tank"> 탱커</label><label><input type="checkbox" name="role" value="Damage"> 딜러</label><label><input type="checkbox" name="role" value="Support"> 힐러</label></div></div><div class="form-group"><label style="cursor:pointer;"><input type="checkbox" id="add-player-side" style="width:auto; margin-right: 5px;">사이드 유무</label></div><button type="submit" class="primary-btn">선수 추가</button></form><ul id="player-list" style="margin-top: 20px;"></ul><div id="data-management" class="section-divider"><h2>데이터 관리</h2><div class="form-group" style="display: flex; gap: 20px; align-items: center;"><button id="export-data-btn" class="data-btn">내보내기</button><p style="font-size: 0.9em;">현재 기록을 파일로 저장합니다.</p></div><div class="form-group" style="display: flex; gap: 20px; align-items: center;"><label for="import-file-input" class="data-btn">가져오기</label><input type="file" id="import-file-input" accept=".json" style="display:none;"><p style="font-size: 0.9em;">파일을 불러와 덮어씁니다.</p></div></div>`;
    views.edit.innerHTML = `<h2>선수 정보 수정</h2><div class="form-group"><label for="edit-player-select">수정할 선수 선택:</label><select id="edit-player-select"></select></div><form id="edit-player-form" style="display:none;"><input type="hidden" id="edit-player-id"><div class="form-group"><label for="edit-player-name">이름:</label><input type="text" id="edit-player-name" required></div><div class="form-group"><label>역할군별 ELO:</label><div class="edit-elo-group"><div><label for="edit-elo-tank">🛡️ 탱커</label><input type="number" id="edit-elo-tank" required></div><div><label for="edit-elo-damage">⚔️ 딜러</label><input type="number" id="edit-elo-damage" required></div><div><label for="edit-elo-support">❤️ 힐러</label><input type="number" id="edit-elo-support" required></div></div></div><div class="form-group"><label>주 역할군:</label><div class="role-selector"><label><input type="checkbox" name="edit-role" value="Tank"> 탱커</label><label><input type="checkbox" name="edit-role" value="Damage"> 딜러</label><label><input type="checkbox" name="edit-role" value="Support"> 힐러</label></div></div><div class="form-group"><label style="cursor:pointer;"><input type="checkbox" id="edit-player-side" style="width:auto; margin-right: 5px;">사이드 유무</label></div><button type="submit" class="primary-btn">변경사항 저장</button></form>`;
    views.stats.innerHTML = `<h2>선수 통계 보기</h2><div class="form-group"><label for="stats-player-select">확인할 선수 선택:</label><select id="stats-player-select"></select></div><div id="player-stats-display"></div>`;
    views.match.innerHTML = `<h2>경기 결과 입력 (1-2-2)</h2><div class="team-selection-container"><div class="team-box"><h3>A팀</h3><div id="team-a-inputs"></div></div><div class="team-box"><h3>B팀</h3><div id="team-b-inputs"></div></div></div><div class="form-group" style="margin-top: 20px;"><label for="winner-selection">승리팀:</label><select id="winner-selection"><option value="A">A팀</option><option value="B">B팀</option></select></div><button id="record-match-btn" class="primary-btn">결과 기록</button>`;
    views.ranking.innerHTML = `<h2>랭킹 보드</h2><p style="font-size: 0.8em; color: #aaa;">선수 이름에 마우스를 올리면 역할군별 상세 기록을 볼 수 있습니다. 순위는 평균 ELO 기준입니다.</p><div style="overflow-x:auto;" id="ranking-table-wrapper"><table id="ranking-table"><thead><tr><th>순위</th><th>이름</th><th>주 역할군</th><th>평균 ELO</th><th>승-패</th><th>승률</th><th>K/D</th><th>평균 딜량</th><th>총 경기수</th></tr></thead><tbody></tbody></table></div>`;
    views.builder.innerHTML = `<section id="auto-team-builder"><h2>스마트 팀 생성 (역할군 기반 밸런싱)</h2><p style="font-size: 0.9em; color: #aaa; margin-bottom: 15px;">아래 역할군별로 선수를 선택해주세요 (탱커 2명, 딜러 4명, 힐러 4명)</p><div id="role-based-player-selection"><div class="role-selection-group"><h4>🛡️ 탱커 (2명)</h4><div class="player-checkbox-list" id="builder-tanks"></div></div><div class="role-selection-group"><h4>⚔️ 딜러 (4명)</h4><div class="player-checkbox-list" id="builder-damages"></div></div><div class="role-selection-group"><h4>❤️ 힐러 (4명)</h4><div class="player-checkbox-list" id="builder-supports"></div></div></div><button id="generate-teams-btn" class="primary-btn" style="margin-top: 20px;">최적의 팀 생성하기</button><div id="generated-teams" class="team-selection-container" style="display: none; margin-top: 20px;"><div id="generated-team-a" class="generated-team-card"></div><div id="generated-team-b" class="generated-team-card"></div></div></section><section id="manual-team-balancer" class="section-divider"><h2>팀 밸런스 직접 보기</h2><div class="team-selection-container"><div class="team-box"><h3>A팀</h3><div id="manual-team-a-inputs"></div><div id="manual-team-a-elo" class="manual-balance-result">평균 ELO: -</div></div><div class="team-box"><h3>B팀</h3><div id="manual-team-b-inputs"></div><div id="manual-team-b-elo" class="manual-balance-result">평균 ELO: -</div></div></div></section>`;
    
    const navButtons = { players: document.getElementById('nav-players'), edit: document.getElementById('nav-edit'), stats: document.getElementById('nav-stats'), match: document.getElementById('nav-match'), ranking: document.getElementById('nav-ranking'), builder: document.getElementById('nav-builder') };
    let appState = { players: [] };
    const K_FACTOR = 32, INITIAL_ELO = 1000, ROLES = ['Tank', 'Damage', 'Support'];
    const roleIcons = { Tank: '🛡️', Damage: '⚔️', Support: '❤️' };

    function getEmptyRoleStats() { return { wins: 0, losses: 0, totalKills: 0, totalDeaths: 0, totalDamage: 0, matchesPlayed: 0 }; }
    function getInitialEloByRole(elo) { return { Tank: elo, Damage: elo, Support: elo }; }
    function saveData() { localStorage.setItem('owScrimManagerData_final_v3', JSON.stringify(appState.players)); }
    function loadData() { const data = localStorage.getItem('owScrimManagerData_final_v3'); if (data) { appState.players = JSON.parse(data).map(p => { if (!p.statsByRole) p.statsByRole = { Tank: getEmptyRoleStats(), Damage: getEmptyRoleStats(), Support: getEmptyRoleStats() }; if (!p.eloByRole) p.eloByRole = getInitialEloByRole(p.elo || INITIAL_ELO); p.hasSide = p.hasSide || false; delete p.elo; return p; }); } }
    function refreshAllViews() { renderPlayerList(); renderEditPlayerView(); renderStatsView(); renderMatchInputs(); renderBuilderPlayerList(); renderRankingBoard(); renderManualBalanceView(); }
    function switchView(viewName) { Object.values(views).forEach(v => v.classList.remove('active')); Object.values(navButtons).forEach(b => b.classList.remove('active')); views[viewName].classList.add('active'); navButtons[viewName].classList.add('active'); refreshAllViews(); }
    Object.keys(navButtons).forEach(key => navButtons[key].addEventListener('click', () => switchView(key)));

    document.getElementById('add-player-form').addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('player-name').value.trim(); const initialElo = document.getElementById('initial-elo').value ? parseInt(document.getElementById('initial-elo').value, 10) : INITIAL_ELO; const roles = Array.from(document.querySelectorAll('input[name="role"]:checked')).map(el => el.value); const hasSide = document.getElementById('add-player-side').checked; if (!name || roles.length === 0) return alert('이름과 역할군을 입력해주세요.'); if (appState.players.some(p => p.name === name)) return alert('이미 존재하는 이름입니다.'); const newPlayer = { id: Date.now(), name, roles, hasSide, eloByRole: getInitialEloByRole(initialElo), statsByRole: { Tank: getEmptyRoleStats(), Damage: getEmptyRoleStats(), Support: getEmptyRoleStats() } }; appState.players.push(newPlayer); saveData(); refreshAllViews(); document.getElementById('add-player-form').reset(); });
    function renderPlayerList() { document.getElementById('player-list').innerHTML = appState.players.map(p => `<li><div><span>${p.name}</span> ${p.roles.map(r => `<span class="role-badge role-${r.toLowerCase()}">${r}</span>`).join('')}</div><button class="danger-btn" data-id="${p.id}">삭제</button></li>`).join(''); }
    document.getElementById('player-list').addEventListener('click', (e) => { if (e.target.classList.contains('danger-btn')) { if (confirm('정말로 이 선수를 삭제하시겠습니까?')) { appState.players = appState.players.filter(p => p.id !== parseInt(e.target.dataset.id)); saveData(); refreshAllViews(); } } });
    
    const editPlayerSelect = document.getElementById('edit-player-select'); const editPlayerForm = document.getElementById('edit-player-form');
    function renderEditPlayerView() { editPlayerSelect.innerHTML = '<option value="">-- 선수 선택 --</option>' + appState.players.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); editPlayerForm.style.display = 'none'; }
    editPlayerSelect.addEventListener('change', () => { const player = appState.players.find(p => p.id === parseInt(editPlayerSelect.value)); if (!player) return editPlayerForm.style.display = 'none'; document.getElementById('edit-player-id').value = player.id; document.getElementById('edit-player-name').value = player.name; document.getElementById('edit-elo-tank').value = Math.round(player.eloByRole.Tank); document.getElementById('edit-elo-damage').value = Math.round(player.eloByRole.Damage); document.getElementById('edit-elo-support').value = Math.round(player.eloByRole.Support); document.querySelectorAll('input[name="edit-role"]').forEach(c => c.checked = player.roles.includes(c.value)); document.getElementById('edit-player-side').checked = player.hasSide; editPlayerForm.style.display = 'block'; });
    editPlayerForm.addEventListener('submit', (e) => { e.preventDefault(); const id = parseInt(document.getElementById('edit-player-id').value); const name = document.getElementById('edit-player-name').value.trim(); const roles = Array.from(document.querySelectorAll('input[name="edit-role"]:checked')).map(el => el.value); const hasSide = document.getElementById('edit-player-side').checked; const eloByRole = { Tank: parseInt(document.getElementById('edit-elo-tank').value), Damage: parseInt(document.getElementById('edit-elo-damage').value), Support: parseInt(document.getElementById('edit-elo-support').value) }; if (!name || roles.length === 0 || isNaN(eloByRole.Tank) || isNaN(eloByRole.Damage) || isNaN(eloByRole.Support)) return alert('모든 필드를 올바르게 입력해주세요.'); const pIndex = appState.players.findIndex(p => p.id === id); if (pIndex > -1) { appState.players[pIndex] = { ...appState.players[pIndex], name, eloByRole, roles, hasSide }; saveData(); refreshAllViews(); alert('선수 정보가 수정되었습니다.'); editPlayerSelect.value = ''; editPlayerForm.style.display = 'none'; } });
    
    const statsPlayerSelect = document.getElementById('stats-player-select'); const statsDisplay = document.getElementById('player-stats-display');
    function renderStatsView() { statsPlayerSelect.innerHTML = '<option value="">-- 선수 선택 --</option>' + appState.players.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); statsDisplay.innerHTML = '<p style="text-align:center; color: #aaa;">선수를 선택하면 상세 통계를 볼 수 있습니다.</p>'; }
    statsPlayerSelect.addEventListener('change', () => { const playerId = parseInt(statsPlayerSelect.value); if (isNaN(playerId)) { statsDisplay.innerHTML = '<p style="text-align:center; color: #aaa;">선수를 선택하면 상세 통계를 볼 수 있습니다.</p>'; return; } const player = appState.players.find(p => p.id === playerId); statsDisplay.innerHTML = ''; ROLES.forEach(role => { if (player.roles.includes(role)) { const s = player.statsByRole[role]; const winRate = s.matchesPlayed > 0 ? ((s.wins / s.matchesPlayed) * 100).toFixed(1) + '%' : 'N/A'; const kd = s.totalDeaths > 0 ? (s.totalKills / s.totalDeaths).toFixed(2) : s.totalKills.toFixed(1); const avgDmg = s.matchesPlayed > 0 ? (s.totalDamage / s.matchesPlayed).toFixed(0) : 0; const card = document.createElement('div'); card.className = 'stat-card'; card.innerHTML = `<div class="stat-card-header"><span class="role-badge role-${role.toLowerCase()}">${roleIcons[role]} ${role}</span><span class="stat-card-elo">${Math.round(player.eloByRole[role])} ELO</span></div><ul class="stat-card-body"><li><strong>승/패:</strong> ${s.wins}승 ${s.losses}패</li><li><strong>승률:</strong> ${winRate}</li><li><strong>K/D:</strong> ${kd}</li><li><strong>평균 딜량:</strong> ${avgDmg.toLocaleString()}</li><li><strong>플레이 수:</strong> ${s.matchesPlayed}회</li></ul>`; statsDisplay.appendChild(card); } }); if (player.hasSide) { statsDisplay.innerHTML += `<p class="side-license-text">이 사람은 사이드 자격증이 있습니다🛣️</p>`; } });
    
    function renderMatchInputs() { const teamA = document.getElementById('team-a-inputs'); const teamB = document.getElementById('team-b-inputs'); teamA.innerHTML = ''; teamB.innerHTML = ''; const roleSlots = [{ role: 'Tank', label: '탱커' }, { role: 'Damage', label: '딜러 1' }, { role: 'Damage', label: '딜러 2' }, { role: 'Support', label: '힐러 1' }, { role: 'Support', label: '힐러 2' }]; const createRow = (slot) => { const players = appState.players.filter(p => p.roles.includes(slot.role)); const options = `<option value="">-- ${slot.label} --</option>` + players.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); return `<div class="player-stat-input-row" data-role="${slot.role}"><strong>${slot.label}:</strong><select class="player-select">${options}</select><input type="number" class="kills-input" placeholder="킬" min="0"><input type="number" class="deaths-input" placeholder="데스" min="0"><input type="number" class="damage-input" placeholder="딜량" min="0"></div>`; }; roleSlots.forEach(slot => { teamA.innerHTML += createRow(slot); teamB.innerHTML += createRow(slot); }); document.querySelectorAll('.player-select').forEach(s => s.addEventListener('change', () => handlePlayerSelectionChange('#view-match .player-select'))); }
    function handlePlayerSelectionChange(selector) { const allSelects = Array.from(document.querySelectorAll(selector)); const selectedIds = new Set(allSelects.map(s => s.value).filter(Boolean).map(Number)); allSelects.forEach(select => { const currentVal = select.value; Array.from(select.options).forEach(opt => { if (opt.value && opt.value !== currentVal) opt.style.display = selectedIds.has(Number(opt.value)) ? 'none' : 'block'; }); }); }
    document.getElementById('record-match-btn').addEventListener('click', () => { const getTeamData = (sel) => Array.from(document.querySelectorAll(`${sel} .player-stat-input-row`)).map(r => ({ id: parseInt(r.querySelector('.player-select').value), role: r.dataset.role, kills: parseInt(r.querySelector('.kills-input').value || 0), deaths: parseInt(r.querySelector('.deaths-input').value || 0), damage: parseInt(r.querySelector('.damage-input').value || 0) })); let teamA_data, teamB_data; try { teamA_data = getTeamData('#team-a-inputs'); teamB_data = getTeamData('#team-b-inputs'); if (teamA_data.some(p => isNaN(p.id)) || teamB_data.some(p => isNaN(p.id))) throw new Error("모든 선수 슬롯을 채워주세요."); if (new Set([...teamA_data.map(p => p.id), ...teamB_data.map(p => p.id)]).size !== 10) throw new Error("중복된 선수가 선택되었습니다."); } catch (e) { return alert(e.message); } const getTeamAvgElo = (teamData) => (teamData.reduce((sum, member) => sum + (appState.players.find(p => p.id === member.id)?.eloByRole[member.role] || 0), 0)) / teamData.length; const avgEloA = getTeamAvgElo(teamA_data); const avgEloB = getTeamAvgElo(teamB_data); const winner = document.getElementById('winner-selection').value; const expectedA = 1 / (1 + Math.pow(10, (avgEloB - avgEloA) / 400)); const eloChange = K_FACTOR * (((winner === 'A') ? 1 : 0) - expectedA); [...teamA_data, ...teamB_data].forEach(mp => { const p = appState.players.find(pl => pl.id === mp.id); p.eloByRole[mp.role] += (teamA_data.some(pl => pl.id === mp.id)) ? eloChange : -eloChange; const roleStats = p.statsByRole[mp.role]; if ((teamA_data.some(pl => pl.id === mp.id) && winner === 'A') || (teamB_data.some(pl => pl.id === mp.id) && winner === 'B')) roleStats.wins++; else roleStats.losses++; roleStats.matchesPlayed++; roleStats.totalKills += mp.kills; roleStats.totalDeaths += mp.deaths; roleStats.totalDamage += mp.damage; }); saveData(); alert('경기 결과가 기록되었습니다!'); switchView('ranking'); });
    
    function renderRankingBoard() { const tableBody = document.querySelector('#ranking-table tbody'); tableBody.innerHTML = ''; const getAverageElo = (p) => (p.eloByRole.Tank + p.eloByRole.Damage + p.eloByRole.Support) / 3; const sortedPlayers = [...appState.players].sort((a, b) => getAverageElo(b) - getAverageElo(a)); sortedPlayers.forEach((player, index) => { let total = { wins: 0, losses: 0, totalKills: 0, totalDeaths: 0, totalDamage: 0, matchesPlayed: 0 }; ROLES.forEach(role => { const s = player.statsByRole[role]; total.wins += s.wins; total.losses += s.losses; total.matchesPlayed += s.matchesPlayed; total.totalKills += s.totalKills; total.totalDeaths += s.totalDeaths; total.totalDamage += s.totalDamage; }); const winRate = total.matchesPlayed > 0 ? ((total.wins / total.matchesPlayed) * 100).toFixed(1) + '%' : 'N/A'; const kd = total.totalDeaths > 0 ? (total.totalKills / total.totalDeaths).toFixed(2) : total.totalKills.toFixed(1); const avgDmg = total.matchesPlayed > 0 ? (total.totalDamage / total.matchesPlayed).toFixed(0) : 0; const rolesHtml = player.roles.map(r => `<span class="role-badge role-${r.toLowerCase()}">${r}</span>`).join(''); let tooltipHtml = ''; ROLES.forEach(role => { if(player.roles.includes(role)){ const s = player.statsByRole[role]; tooltipHtml += `<div class="tooltip-section"><div class="tooltip-elo"><strong>${roleIcons[role]} ${role} ELO:</strong> ${Math.round(player.eloByRole[role])}</div>`; if (s.matchesPlayed > 0) { const rWR = ((s.wins / s.matchesPlayed) * 100).toFixed(1); const rKD = s.totalDeaths > 0 ? (s.totalKills / s.totalDeaths).toFixed(2) : s.totalKills.toFixed(1); tooltipHtml += `<div class="tooltip-role-stats">${s.wins}승 ${s.losses}패 (${rWR}%) / K/D ${rKD}</div>`; } tooltipHtml += `</div>`;}}); const tr = document.createElement('tr'); tr.innerHTML = `<td class="${index < 3 ? `rank-${index + 1}` : ''}">${index + 1}</td><td class="player-name-cell">${player.name}<div class="player-tooltip">${tooltipHtml || '기록 없음'}</div></td><td>${rolesHtml}</td><td><strong>${Math.round(getAverageElo(player))}</strong></td><td>${total.wins}-${total.losses}</td><td>${winRate}</td><td>${kd}</td><td>${avgDmg.toLocaleString()}</td><td>${total.matchesPlayed}</td>`; tableBody.appendChild(tr); }); }
    document.getElementById('ranking-table-wrapper').addEventListener('mouseover', (e) => { const cell = e.target.closest('.player-name-cell'); if (!cell) return; const tooltip = cell.querySelector('.player-tooltip'); const rect = cell.getBoundingClientRect(); if (rect.top < 350) { tooltip.classList.add('show-below'); } else { tooltip.classList.remove('show-below'); } });
    
    function renderBuilderPlayerList() { const containers = { Tank: document.getElementById('builder-tanks'), Damage: document.getElementById('builder-damages'), Support: document.getElementById('builder-supports') }; Object.values(containers).forEach(c => c.innerHTML = ''); ROLES.forEach(role => { const playersWithRole = appState.players.filter(p => p.roles.includes(role)); playersWithRole.forEach(p => { containers[role].innerHTML += `<label><input type="checkbox" value="${p.id}" data-role="${role}"> ${p.name} (${p.eloByRole[role].toFixed(0)})</label>`; }); }); }
    document.getElementById('generate-teams-btn').addEventListener('click', () => {
        const getSelected = (role) => Array.from(document.querySelectorAll(`#builder-${role.toLowerCase()}s input:checked`))
            .map(el => ({ player: appState.players.find(p => p.id === parseInt(el.value)), role: el.dataset.role }));
        const tanks = getSelected('Tank'), damages = getSelected('Damage'), supports = getSelected('Support');
        if (tanks.length !== 2 || damages.length !== 4 || supports.length !== 4) return alert('선택 인원을 확인해주세요 (탱커 2, 딜러 4, 힐러 4).');
        const findBestPairing = (players, role) => { const p = players.map(item => item.player); const pairings = [{ p1: [p[0],p[1]], p2: [p[2],p[3]] },{ p1: [p[0],p[2]], p2: [p[1],p[3]] },{ p1: [p[0],p[3]], p2: [p[1],p[2]] }]; let bestPairing = null, minDiff = Infinity; pairings.forEach(pair => { const diff = Math.abs(((pair.p1[0].eloByRole[role] + pair.p1[1].eloByRole[role])/2) - ((pair.p2[0].eloByRole[role] + pair.p2[1].eloByRole[role])/2)); if (diff < minDiff) { minDiff = diff; bestPairing = [pair.p1, pair.p2]; } }); return bestPairing.map(team => team.map(player => ({ player, role }))); };
        const [t1_obj, t2_obj] = tanks.sort((a,b) => b.player.eloByRole.Tank - a.player.eloByRole.Tank);
        const [bestDmg1, bestDmg2] = findBestPairing(damages, 'Damage');
        const [bestSup1, bestSup2] = findBestPairing(supports, 'Support');
        const calcTotalRoleElo = (team) => team.reduce((sum, p_obj) => sum + p_obj.player.eloByRole[p_obj.role], 0);
        const team1_c1 = [t1_obj, ...bestDmg1, ...bestSup1], team2_c1 = [t2_obj, ...bestDmg2, ...bestSup2]; const diff1 = Math.abs(calcTotalRoleElo(team1_c1) - calcTotalRoleElo(team2_c1));
        const team1_c2 = [t1_obj, ...bestDmg1, ...bestSup2], team2_c2 = [t2_obj, ...bestDmg2, ...bestSup1]; const diff2 = Math.abs(calcTotalRoleElo(team1_c2) - calcTotalRoleElo(team2_c2));
        let finalA = (diff1 <= diff2) ? team1_c1 : team1_c2, finalB = (diff1 <= diff2) ? team2_c1 : team2_c2;
        const formatTeam = (team, name) => { const avgElo = (team.reduce((s, p_obj) => s + (p_obj.player.eloByRole.Tank + p_obj.player.eloByRole.Damage + p_obj.player.eloByRole.Support) / 3, 0)) / team.length; const list = team.sort((a,b) => ROLES.indexOf(a.role) - ROLES.indexOf(b.role)).map(p_obj => { const { player, role } = p_obj; let rolesHtml = `<span class="role-badge role-${role.toLowerCase()}">${roleIcons[role] || ''} ${role}</span>`; if (role === 'Damage' && player.hasSide) { rolesHtml = `🛣️ ` + rolesHtml; } return `<div class="player-card"><span class="player-name">${player.name} <small>(${player.eloByRole[role].toFixed(0)})</small></span><span>${rolesHtml}</span></div>`; }).join(''); return `<div class="card-header"><h3>${name}</h3><span class="avg-elo">평균 ELO: ${avgElo.toFixed(0)}</span></div><div class="player-list-container">${list}</div>`; };
        document.getElementById('generated-team-a').innerHTML = formatTeam(finalA, 'A팀'); document.getElementById('generated-team-b').innerHTML = formatTeam(finalB, 'B팀'); document.getElementById('generated-teams').style.display = 'grid';
    });
    
    document.getElementById('export-data-btn').addEventListener('click', () => { if (appState.players.length === 0) return alert('내보낼 데이터가 없습니다.'); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(appState.players, null, 2)], {type:'application/json'})); a.download = 'overwatch_data.json'; a.click(); URL.revokeObjectURL(a.href); });
    document.getElementById('import-file-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (re) => { try { const data = JSON.parse(re.target.result); if (!Array.isArray(data)) throw new Error('올바른 데이터 형식이 아닙니다.'); if (confirm('데이터를 불러오면 현재 기록이 모두 사라집니다. 계속하시겠습니까?')) { appState.players = data.map(p => { if(!p.eloByRole) p.eloByRole = getInitialEloByRole(p.elo || INITIAL_ELO); if(!p.statsByRole) p.statsByRole = {Tank:getEmptyRoleStats(),Damage:getEmptyRoleStats(),Support:getEmptyRoleStats()}; p.hasSide = p.hasSide || false; delete p.elo; return p; }); saveData(); refreshAllViews(); alert('데이터를 성공적으로 불러왔습니다!'); } } catch (err) { alert('파일 오류: ' + err.message); } e.target.value = ''; }; reader.readAsText(file); });
    
    function renderManualBalanceView() { const teamA = document.getElementById('manual-team-a-inputs'); const teamB = document.getElementById('manual-team-b-inputs'); teamA.innerHTML = ''; teamB.innerHTML = ''; const options = `<option value="">-- 선수 선택 --</option>` + appState.players.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); for (let i = 0; i < 5; i++) { const select = `<div class="form-group"><select class="manual-balance-select">${options}</select></div>`; teamA.innerHTML += select; teamB.innerHTML += select; } document.querySelectorAll('.manual-balance-select').forEach(s => { s.addEventListener('change', () => { calculateManualBalance(); handlePlayerSelectionChange('.manual-balance-select'); }); }); calculateManualBalance(); handlePlayerSelectionChange('.manual-balance-select'); }
    function calculateManualBalance() { const getAvgElo = (sel) => { const ids = Array.from(document.querySelectorAll(sel)).map(s => parseInt(s.value)).filter(id => !isNaN(id)); if (ids.length === 0) return '-'; const totalElo = ids.reduce((sum, id) => { const p = appState.players.find(player => player.id === id); return sum + (p ? (p.eloByRole.Tank+p.eloByRole.Damage+p.eloByRole.Support)/3 : 0); }, 0); return (totalElo / ids.length).toFixed(0); }; document.getElementById('manual-team-a-elo').textContent = `평균 ELO: ${getAvgElo('#manual-team-a-inputs .manual-balance-select')}`; document.getElementById('manual-team-b-elo').textContent = `평균 ELO: ${getAvgElo('#manual-team-b-inputs .manual-balance-select')}`; }
    
    loadData(); refreshAllViews(); switchView('players');
});
</script>
</body>
</html>